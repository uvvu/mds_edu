#include <stdio.h>
#include <unistd.h>
#include <fcntl.h>  /* for O_RDONLY */
#include  <sys/mman.h> /* for mmap */
#include <linux/fb.h>  /* for fb_var_screeninfo, FBIOGET_VSCREENINFO */
#include <stdlib.h>
#include <unistd.h>
#include <sys/mman.h>
#include "bmp.h"

#define FBDEVFILE "/dev/fb1"

#define COLS 800
#define ROWS 480

/* ?Á·Î±×·?À» ?ß¸? ???? ??Å³?? ???À´? ?Á·Î±×·? ???????? */
void usage()
{
	printf("\n=====================================\n");
	printf("\nUsage: ./drawbmp  xxx.bmp \n");
	printf("\n=====================================\n");
}

/* bmp???Ï¿??? ?×¸? Á¤???? ?????Í¸? ?Ì¾? ???? ?Ô¼? */
/* ??À°?? ???Ç¼?À» À§?? 24bit Æ®?? Ä®???????? ?????? ?? ??À½ */
 void read_bmp(char *filename, char **pDib, char **data, int *cols, int *rows)
{
	BITMAPFILEHEADER bmpHeader;
	BITMAPINFOHEADER *bmpInfoHeader;
	unsigned int size;
	unsigned char ID[2];
	int nread;
	FILE *fp;

	fp = fopen(filename,"rb");
	if(fp == NULL) {
		printf("ERROR\n");
		return;
	}
	
	ID[0] = fgetc(fp);
	ID[1] = fgetc(fp);
	
	/*  BMP ??Å©?? È®?? */
	if(ID[0] != 'B' && ID[1] != 'M') {
		fclose(fp);
		return;
	}

	/* bmp ???Ï¿??? BITMAPFILEHEADER ??Å­ ??À½ */
	nread = fread(&bmpHeader.bfSize,1,sizeof(BITMAPFILEHEADER),fp);
	size = bmpHeader.bfSize - sizeof(BITMAPFILEHEADER);	// bmp headerë¥¼ ì œì™¸í•œ ì‚¬ì´ì¦ˆë¥¼ êµ¬í•¨.

	/* À§???? ??Àº size??Å« ?Þ¸ð¸®¸? ???? ?Ï¾î¼­ pDib?? ??À½*/
	*pDib = (unsigned char *)malloc(size);	
	fread(*pDib,1,size,fp);
	
	/* À§???? ??Àº pDib???? BITMAPINFOHEADER?? ?????? */
	bmpInfoHeader = (BITMAPINFOHEADER *)*pDib;
	
	/* 24??Æ® true Ä®?? ?Ö¶??? ???? ?? ?? ?Öµ??? ?? */
	if(24 != bmpInfoHeader->biBitCount)
	{
		printf("It supports only 24bit bmp!\n");
		fclose(fp);
		return;
	}
		
	/* BITMAPINFOHEADER???? ???Î¿? ???? ??????À» ???? */
	*cols = bmpInfoHeader->biWidth;
	*rows = bmpInfoHeader->biHeight;
	
	/* ??Á¦ ???????? ?Ö¼Ò¸? ??Á®?? */
/* Ã³À½ À§Ä¡???? ?????Í°? À§Ä¡?? ?? ?????? offset?Ì¹Ç·? bmpHeader ??Å­ ???Ö°?, ?Õ¼? signature?? ??À¸?é¼­ ?Òº??? 2????Æ®?? ???Ö¾??? ??. */
	*data = (char *)(*pDib + bmpHeader.bfOffBits - sizeof(bmpHeader)-2);
	fclose(fp);
}

/* ?Ò´??? ?Þ¸??? ??Á¦ */	
void close_bmp(char **pDib)
{
	free(*pDib);
}

int main(int argc, char *argv[])
{
	int cols, rows;
	char *pData,*data;
	char r,g,b;

	unsigned int bmpdata1[ROWS][COLS];
	unsigned int pixel;
	unsigned int *pfbmap;
	struct fb_var_screeninfo fbvar;
	int fbfd;
	int i,j,k,t;
	

	if(argc != 2){
		usage();
		return 0;
	}
	
	/* ?Á·??? ???Û¸? ???? ?? */
	fbfd = open(FBDEVFILE, O_RDWR);
	
	if(fbfd < 0){
		perror("fbdev open");
		exit(1);
	}

	/* mmap ?Ô¼??? ?Ì¿??Ï¿? flame buffer?? ?Þ¸????? ???? ?Ö¼Ò¸? ?????? */
	/* 1 pixel?? 2byte?? ?Ê¿??Ï¹Ç·? *2 */
	pfbmap = (unsigned int *)
		mmap(0, COLS*ROWS*4,PROT_READ|PROT_WRITE, MAP_SHARED, fbfd, 0);

	if((unsigned)pfbmap == (unsigned)-1)
	{
		perror("fbdev mmap");
		exit(1);
	}

	/*  bmp????À» ?Ð¾? ?å¸² */	
	read_bmp(argv[1], &pData, &data, &cols,&rows);


	/**************************** Image 1 *********************************/
	i=0;j=0;k=0;

	for(j=0;j<rows;j++){
		k = j*cols*3; /* ?? ?È¼??? 3byte?Î°?À» 2byte?? ?Ù²? */
		printf("cols = %d, rows = %d, k = %d\n", cols, j+1, k);
		/* bmp image?? ?????? ?????Ç¹Ç·? ?Ø¿??????? ?Ð¾??Í¾? ??. */
		for(i=0;i<cols;i++)
		{ 
			b = *(data + (k + i*3));
			g = *(data + (k + i*3+1));
			r = *(data + (k + i*3+2));

			pixel = (r << 16) | (g << 8) | (b);
			bmpdata1[(rows-1-j)][i] = pixel;
		}
	} 	
	/*  bmp ???Ï¿??? ??Àº data?? ?Á·??? ?????? ?Þ¸ð¸®·? Ä«?? ?? */
	//memcpy(pfbmap, bmpdata1, COLS*ROWS*4);
	memcpy(pfbmap, bmpdata1, COLS*ROWS*4);
	
	/*      È°?? ??Àº ?Þ·Î¸???À» ??Á¦?? ?? ?Á·??? ???Û·? close ?? */
	munmap(pfbmap,ROWS*COLS*4);
	close_bmp(&pData);
	close(fbfd);
	return 0;
}
